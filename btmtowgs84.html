<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTMvisualizer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>

    <!-- Bootstrap CSS -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!--Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />

    <!--Styles-->
    <style>

    .map-page {
        width: 100%;
        min-height: calc(100vh - 92px - 56px);
        display: inline-block;
        display: flex;
        align-items: center;
        justify-content: center;
        align-content: center;
        flex-direction: column;
    }
    </style>
</head>
<body>
	<div class="d-flex justify-content-center">
		<h2>BTM Visualizer</h2>
	</div>
    <div class="d-flex justify-content-center">

        <form id="frm" class="row p-2">
            <div class="col-4">
                <input type="number" class="form-control" placeholder="Easting" id="easting" aria-label="Easting" required>
            </div>
            <div class="col-4">
                <input type="number" class="form-control" placeholder="Northing" id="northing" aria-label="Northing" required>
            </div>

            <div class="col-4">
                <button type="button" class="btn btn-primary" id="btnAddMarker">Visualize</button>
            </div>
        </form>
    </div>
    <div> 
        <div id="mapdiv" class="map-page"></div>
    </div>
	
	<!--Footer-->
    <footer class="bg-light text-center text-lg-start">
      <!-- Copyright -->
      <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
        Developed by <a class="text-dark" href="https://mdmanzurrahman.github.io">Md Manzur Rahman</a>
      </div>
      <!-- Copyright -->
    </footer>


</body>
    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/1.4.0/proj4.js" integrity="sha512-9FBAecJh0Z6E49D3yaooSbeH7Br8Pe+jVCsZVfo4alGWOuv5RqKwE5YsCv88Ma0iG8aUGWvfb92zDVJ9ywJPHA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="text/javascript">
    //Custom Projection: BTM using Local Datum Everest 1930 (1937 Adjustment)
    var proj_name = 'BTM'
    var a = 6377276.34518
    var b = 6356075.41511
    var f = (a-b)/a
    var f_inverse = 1/f
    var dx = 283.7
    var dy = 735.9
    var dz = 261.1
    var rx = 0
    var ry = 0
    var rz = 0
    var s = 0
    var proj = 'tmerc'  // Transverse Mercator
    var fe = 500000     // False Easting
    var fn = -2000000   // False Northing
    var k = 0.9996      // Scale Factor
    var lat_origin = 0  // Central Parallel
    var lon_origin = 90 // Central Meridian
    var unit = 'm'      // unit in meter
    var btm = `+proj=${proj} +lat_0=${lat_origin} +lon_0=${lon_origin} +k=${k} +x_0=${fe} +y_0=${fn} +a=${a} +b=${b} +towgs84=${dx},${dy},${dz},${rx},${ry},${rz},${s} +units=${unit} +no_defs`
    
    //GCS WGS84
    var wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
    
    //Function to convert btm projected coordinates to WGS84 geographic coordinates
    //Easting = 557825m and Northing = 666932m gives Latitude = 24.116377062446542degree and Longitude = 90.5662427832349 respectively
    function btm_to_wgs84(easting, northing){
        var lon = proj4(btm,wgs84,[easting, northing])[0].toFixed(6);
        var lat = proj4(btm,wgs84,[easting, northing])[1].toFixed(6);
        return [lat, lon];
    };
	
	//Function to convert from WGS84 geographic coordinates to btm projected coordinates
	function wgs84_to_btm(lat, lon){
        var easting = proj4(wgs84,btm,[lon, lat])[0].toFixed(0);
        var northing = proj4(wgs84,btm,[lon, lat])[1].toFixed(0);
        return [easting, northing];
    };
	
	//Test BTM to WGS84
    //var easting = 557825
    //var northing = 666932
	//var lat = btm_to_wgs84(easting, northing)[0]
    //var lon = btm_to_wgs84(easting, northing)[1]
	//console.log(lat, lon);
	
	//Test WGS84 to BTM
	//var lat = 24.116377062446542
	//var lon = 90.5662427832349
	//var easting = wgs84_to_btm(lat , lon)[0]
	//var northing = wgs84_to_btm(lat , lon)[1]
    //console.log(easting, northing);

    //console.log(proj4(btm,wgs84,[557825, 666932]));
	
</script>


<script type="text/javascript">
    //Latlon of PaniBhaban
    var defaultLat = 23.751304243418687;
    var defaultLon = 90.38852600972048;
    var defaultZoom = 7;
            //Leaflet Functions
    var map = L.map('mapdiv', {
            center: [defaultLat, defaultLon],
            zoom: defaultZoom,
            zoomControl:true, 
            attributionControl:true
        })//.fitWorld();
    var lyrOSM = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
    //CartoDB layer names: light_all / dark_all / light_nonames / dark_nonames
    var layerCartoDB = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    });
    var esriWorldGray = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
            maxZoom: 16
        });
    var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
    var layerGoogleMap = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {attribution: '&copy; Google'});
    var layerGoogleMapSatelliteHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {attribution: '&copy; Google'});
    //https://leaflet-extras.github.io/leaflet-providers/preview/ for more basemaps
    map.addLayer(layerGoogleMapSatelliteHybrid);
    // or, add to an existing map:
    map.addControl(new L.Control.Fullscreen());
	
	
	//Adding Watermark Logo
    L.Control.Watermark = L.Control.extend({
        onAdd: function(map) {
            var img = L.DomUtil.create('img');

            img.src = 'assets/img/favicon.ico';
            img.style.width = '30px';

            return img;
        },

        onRemove: function(map) {
            // Nothing to do here
        }
    });

    L.control.watermark = function(opts) {
        return new L.Control.Watermark(opts);
    }
    L.control.watermark({ position: 'bottomright' }).addTo(map);
	
	
	//Adding Scale
	L.control.scale({ position: 'bottomright' }).addTo(map);
	
	
	// Create additional Control placeholders
	function addControlPlaceholders(map) {
		var corners = map._controlCorners,
			l = 'leaflet-',
			container = map._controlContainer;

		function createCorner(vSide, hSide) {
			var className = l + vSide + ' ' + l + hSide;

			corners[vSide + hSide] = L.DomUtil.create('div', className, container);
		}

		createCorner('verticalcenter', 'left');
		createCorner('verticalcenter', 'right');
	}
	addControlPlaceholders(map);
		
	//Adding A Map Title
	L.Control.textbox = L.Control.extend({
		onAdd: function(map) {
			
		var text = L.DomUtil.create('div');
		text.id = "info_text";
		text.innerHTML = "<strong>text here</strong>"
		return text;
		},

		onRemove: function(map) {
			// Nothing to do here
		}
	});
	L.control.textbox = function(opts) { return new L.Control.textbox(opts);}
	L.control.textbox({ position: 'verticalcenterright' }).addTo(map);
	var marker
	
	$(document).ready(function(){
		$("#btnAddMarker").click(function(){
		
			/*
			if ($("#frm")[0].checkValidity())
				alert('sucess');
			else
				//Validate Form
				$("#frm")[0].reportValidity()
			*/
			if ($("#frm")[0].checkValidity()) {
				
				//on successful validation
				var easting = $("#easting").val()
				var northing = $("#northing").val()
				var lat = btm_to_wgs84(easting, northing)[0]
				var lon = btm_to_wgs84(easting, northing)[1]
				
				// First remove previously created marker if any
				if (marker){
					map.removeLayer(marker)
				};
				
				//Add New Marker
				marker = L.marker([lat, lon], {
					draggable: true,
				})
				.addTo(map)
				.bindPopup(`Easting: ${easting} &#8594 Longitude:${lon}<br>Northing: ${northing} &#8594 Latitude:${lat}`)
				.openPopup();
				
				
				if (marker) {
					marker.on('dragend', function(e) {
						lat = marker.getLatLng().lat.toFixed(6)
						lon = marker.getLatLng().lng.toFixed(6)
						console.log(lat,lon)
						var easting = wgs84_to_btm(lat , lon)[0]
						var northing = wgs84_to_btm(lat , lon)[1]
						console.log(easting, northing);
						$("#easting").val(easting);
						$("#northing").val(northing);
						//Update marker popup
						marker.setLatLng(marker.getLatLng(),{draggable:true})
							.bindPopup(`Easting: ${easting} &#8594 Longitude:${lon}<br>Northing: ${northing} &#8594 Latitude:${lat}`).update().openPopup();
					});
				}; 
				
			} else {
				$("#frm")[0].reportValidity()
			}
		});
	});


	
</script>
</html>