<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Runline</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
	
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
	
	<!-- Bootstrap CSS -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	
    <style type="text/css">
		html,body{height:100%;}
		.map-page {
			width: 100%;
			min-height: 50vh;
			display: inline-block;
			display: flex;
			align-items: center;
			justify-content: center;
			align-content: center;
			flex-direction: column;
		}
    </style>
</head>
<body>

	<div class="container-fluid">
		<div class="row">
			<h4 class="col-12 text-center">Transects Generation Tool</h4>
		</div>
		<div class="row">
			<p class="col-12 text-center"><b><u>Instruction</u></b></br>Draw a polyline in Google Earth. Remeber the drawing direction since it will be required to determine transects drawing side (e.g., Left transects will be drawn perpendicular on the left side of drawing direction). Upload the KML file. Input the <b>Transect Interval</b> in meter (i.e., distance between two consecutive transects). Input the total <b>Transect Size</b> in meter. Select the side of drawing. Choose the projected coordinate system to get the coordinate in Easting, Northing. Finally click <b>Download CSV</b> to download geolocations of left and right point of transects in desired format</p>
			<p class="col-12 text-center">Written By: <b><u><a href="https://mdmanzurrahman.github.io">Md Manzur Rahman</a></u></b>, Sub-Divisional Engineer (Civil), Central GIS Directorate, Bangladesh Water Development Board</p>
		</div>
		
		<div class="row justify-content-center">
		
			<div class="col-auto g-3">
				<label class="form-label" for="fileUpload">KML Upload:</label>
				<input class="form-control" type="file" id="fileUpload"  accept=".kml"/>
			</div>
			
			<div class="col-auto g-3">
				<label class="form-label" for="transectInterval">Transect Interval (m):</label>
				<input class="form-control" type="number" id="transectInterval" name="transectInterval" value=500>
			</div>
			
			<div class="col-auto g-3">
				<label class="form-label" for="transectLength">Transect Length (m):</label>
				<input class="form-control" type="number" id="transectLength" name="transectInterval" value=200>
			</div>
			
			<div class="col-auto g-3">
				<label class="form-label" for="transectLength">Choose side of the Transects</label>
				<select class="form-select" name="transectSide" id="transectSide">
				  <option value="leftTransect">Left</option>
				  <option value="rightTransect">Right</option>
				  <option value="bothTransect" selected>Both</option>
				</select>
			</div>
			
			<div class="col-auto g-3">
				<label class="form-label" for="convertToVal">Choose Projection</label>
				<select class="form-select" name="convertToVal" id="convertToVal">
				  <option value="UTM45N" selected>UTM45N</option>
				  <option value="UTM46N">UTM46N</option>
				</select>
			</div>
		</div>
		
		<div class="row justify-content-center">	
			<div class="col-auto g-3">
				<input class="btn btn-success" type="button" id="upload" value="Compute" />
			</div>
			
			
			<div class="col-auto g-3">
				<input type="button" id="downloadCSV" class="btn btn-primary" value="Download CSV" disabled />
			</div>
			
			<div class="col-auto g-3">
				<input type="button" id="btnReset" class="btn btn-danger" value="Reset" />
			</div>
		</div>
		
		<hr />
		<div class="row">
			<div id="mapdiv" class="map-page"></div>
		</div>

	
	</div>

	<div id="dvTable"></div>
</body>

    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/1.4.0/proj4.js" integrity="sha512-9FBAecJh0Z6E49D3yaooSbeH7Br8Pe+jVCsZVfo4alGWOuv5RqKwE5YsCv88Ma0iG8aUGWvfb92zDVJ9ywJPHA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
	
	<script src="js/bangladesh-projections-min.js"></script>

	
    <script type="text/javascript">
	
		//var convertFromVal = "WGS84"
		//var convertToVal = "UTM45N"
		var coords = []
		//var latitude = []
		//var longitude = []
		//var easting = []
		//var northing = []
		//var transectInterval = 0.1 //kilometer
		//var transectLength = 0.2 //kilometer
        $(function () {
            $("#upload").bind("click", function () {
                var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.kml)$/;
                if (regex.test($("#fileUpload").val().toLowerCase())) {
                    if (typeof (FileReader) != "undefined") {
						var transectInterval = $("#transectInterval").val()/1000
						var transectLength = $("#transectLength").val()/1000
						var transectSide = $("#transectSide").val()
						var convertFromVal = "WGS84"
						var convertToVal = $("#convertToVal").val()

						
						
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            var xmlDoc = $.parseXML(e.target.result);
                            var coordinates = $(xmlDoc).find("coordinates")[0].innerHTML.trim().split(" ");
							//console.log(coordinates)
							for (var i = 0; i < coordinates.length; i++){
								var lat = Number(coordinates[i].split(",")[1])
								var lon = Number(coordinates[i].split(",")[0])
								//est = convert_coordinate(convertFromVal, convertToVal, lon, lat)[1].toFixed(0)
								//nrt = convert_coordinate(convertFromVal, convertToVal, lon, lat)[0].toFixed(0)
								//latitude.push(lat)
								//longitude.push(lon)
								//easting.push(est)
								//northing.push(nrt)
								coords.push([lat,lon])
							}
							//console.log(coords)

							var l = L.polyline(coords).addTo(map)
							var jsonLine=l.toGeoJSON();
							//console.log(jsonLine);
							var length = turf.lineDistance(jsonLine, 'kilometers');
							//var dist=Math.floor(length);
							//console.log("Shape Length", length, "km")
							
							//create a blank intermediate point featurecollection
							var interimPointsJson = {
								"type": "FeatureCollection",
								"features": []
							};
							
							//Create a blank feature collection to store adjacents to the interim point
							var transectPointsJson = {
								"type": "FeatureCollection",
								"features": []
							};
							
							//Create a blank feature collection to store transects 
							var transectLinesJson = {
								"type": "FeatureCollection",
								"features": []
							};
							
							
							//Create HTML table for visualiztion of Data and download as csv
							console.log("sl","Easting", "Northing", "Location")
							var table_html = '<table class="table table-bordered table-hover p-2">';
							table_html += '<tr><th>SL</th><th>Easting</th><th>Northing</th><th>Location</th></tr>';
							
							for(let i = 1; i <= length / transectInterval; i++){
								interimPointsJson.features.push(turf.along(jsonLine, i * transectInterval,'kilometers'));
								
								
								var interimPoint = turf.along(jsonLine, i * transectInterval,'kilometers');
								var backPoint = turf.along(jsonLine, ((i * transectInterval)-(0.01*transectInterval)),'kilometers');
								var forePoint = turf.along(jsonLine, ((i * transectInterval)+(0.01*transectInterval)),'kilometers');
								var bearing = turf.bearing(backPoint, forePoint)
								
								if (transectSide == "leftTransect") {
									var adjacentLeft = turf.rhumbDestination(interimPoint, transectLength, bearing-90, {units: 'kilometers'});
									var adjacentRight = interimPoint
								} else if (transectSide == "rightTransect") {
									var adjacentLeft = interimPoint
									var adjacentRight = turf.rhumbDestination(interimPoint, transectLength, bearing+90, {units: 'kilometers'});
								} else if (transectSide == "bothTransect") {
									var adjacentLeft = turf.rhumbDestination(interimPoint, transectLength/2, bearing-90, {units: 'kilometers'});
									var adjacentRight = turf.rhumbDestination(interimPoint, transectLength/2, bearing+90, {units: 'kilometers'});
								} else {
									alert("Please Select Side");
									window.location.reload();
								}

								transectPointsJson.features.push(adjacentLeft)
								transectPointsJson.features.push(adjacentRight)
								
								//Left Point
								var lonLeft = adjacentLeft.geometry.coordinates[0] //turfjs lon is in first position
								var latLeft = adjacentLeft.geometry.coordinates[1] //turfjs lat is in second position
								var estLeft = convert_coordinate(convertFromVal, convertToVal, lonLeft, latLeft)[0].toFixed(2)
								var nrtLeft = convert_coordinate(convertFromVal, convertToVal, lonLeft, latLeft)[1].toFixed(2)
								console.log(i*2-1,estLeft, nrtLeft, "Left")
								table_html += `<tr><td>${i*2-1}</td><td>${estLeft}</td><td>${nrtLeft}</td><td>Left</td></tr>`;

								
								//Right Point
								var lonRight = adjacentRight.geometry.coordinates[0] //turfjs lon is in first position
								var latRight = adjacentRight.geometry.coordinates[1] //turfjs lat is in second position
								var estRight = convert_coordinate(convertFromVal, convertToVal, lonRight, latRight)[0].toFixed(2)
								var nrtRight = convert_coordinate(convertFromVal, convertToVal, lonRight, latRight)[1].toFixed(2)
								console.log(i*2,estRight, nrtRight, "Right")
								table_html += `<tr><td>${i*2}</td><td>${estRight}</td><td>${nrtRight}</td><td>Right</td></tr>`;
								
								transectLine = turf.lineString([adjacentLeft.geometry.coordinates, adjacentRight.geometry.coordinates]);
								transectLinesJson.features.push(transectLine);
								
							}
							//console.log(interimPoints.features[0].geometry.coordinates)
							//L.geoJson(transectPointsJson).addTo(map);
							L.geoJson(transectLinesJson).setStyle({color: 'red', weight: 2}).addTo(map);
							map.fitBounds(l.getBounds())
							console.log(transectPointsJson.features)
							
							table_html += '</table>';
                            var dvTable = $("#dvTable");
                            dvTable.html("");
                            dvTable.append(table_html);
							
							
							$('#downloadCSV').removeAttr('disabled');
							$('#upload').prop('disabled', true);
							
                        }
                        reader.readAsText($("#fileUpload")[0].files[0]);
                    } else {
                        alert("This browser does not support HTML5.");
                    }
                } else {
                    alert("Please upload a valid KML file.");
                }
            });
        });
		
		//Leaflet (like Google Maps) uses the [latitude, longitude] schema, while Turf follows the GeoJSON definition of [longitude, latitude], i.e. the equivalent of [x, y] on a geometrical plane.
		function getLeafletCoordsFromTurf(point) {
			return turf.getCoords(point).slice().reverse();
		}

    </script>
	
	<script type="text/javascript">

		function downloadCSVFile(csv, filename) {
			var csv_file, download_link;
			csv_file = new Blob([csv], {type: "text/csv"});
			download_link = document.createElement("a");
			download_link.download = filename;
			download_link.href = window.URL.createObjectURL(csv_file);
			download_link.style.display = "none";
			document.body.appendChild(download_link);
			download_link.click();
			//window.location.reload();
		}
		
		function htmlToCSV(html, filename) {
			var data = [];
			var rows = document.querySelectorAll("table tr");
			for (var i = 0; i < rows.length; i++) {
				var row = [], cols = rows[i].querySelectorAll("td, th");
				 for (var j = 0; j < cols.length; j++) {
				        row.push(cols[j].innerText);
		                 }
				data.push(row.join(","));		
			}

			//to remove table heading
			//data.shift()

			downloadCSVFile(data.join("\n"), filename);
		}
		
		$( "#downloadCSV" ).click(function(){
			var html = document.querySelector("table").outerHTML;
			htmlToCSV(html, "runline.csv");
		});
		
		/*
		$("#mapShow").click(function(){
			var x = document.getElementById("mapdiv");
			if (x.style.display === "none") {
				x.style.display = "block";
			} else {
				x.style.display = "none";
			}
		});
		*/
		
		$("#btnReset").click(function(){
			document.location.reload(true);
		});

	</script>
	
	<script>
		//Define Variable
		var marker
		
		//Latlon of PaniBhaban
		var defaultLat = 23.751304243418687;
		var defaultLon = 90.38852600972048;
		var defaultZoom = 7;
		
		var bounds = new L.LatLngBounds(new L.LatLng(19, 87), new L.LatLng(27, 93));
		
		//Defining a leaflet map object
		var map = L.map('mapdiv', {
				center: [defaultLat, defaultLon],
				zoom: defaultZoom,
				zoomControl:true, 
				attributionControl:true,
				maxBounds: bounds,
				maxBoundsViscosity: 0.1
			})
		//map.fitWorld();	
		//map.fitBounds(bounds)
		//map.fitBounds([[20, 88], [26, 92]])
		
			
		//Basemaps xyz services	//https://leaflet-extras.github.io/leaflet-providers/preview/ for more basemaps
		var lyrOSM = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
		var layerCartoDB = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
		});//CartoDB layer names: light_all / dark_all / light_nonames / dark_nonames
		var esriWorldGray = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
				attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
				maxZoom: 16
			});
		var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
		});
		var layerGoogleMap = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
			attribution: '&copy; Google',
			maxZoom: 20
		});
		var layerGoogleMapSatelliteHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
			attribution: '&copy; Google',
			maxZoom: 20
		});
		
		//Add Basemap to Leaflet Map
		map.addLayer(layerGoogleMapSatelliteHybrid);
	</script>

</html>
