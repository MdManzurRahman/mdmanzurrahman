<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>coordinate converstion</title>
	
	    <!-- Bootstrap CSS -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
	
    
	<div class="container-fluid">
		<div class="row">
			<h4 class="col-12 text-center">Coordinate Conversion Tool</h4>
		</div>
		<div>
			<p class="col-12 text-center"><b><u>Instruction</u></b></br>Make sure there are <b>Latitude</b> and <b>Longitude</b> column header in your csv file while converting from geographic coordinate system <i>(e.g., WGS84, GULSHAN303)</i> or <b>Easting</b> and <b>Northing</b> while converting from projected coordinate system <i>(e.g., BTM, BUTM2010, UTM45N, UTM46N)</i>. Column header names are case sensitive</p>
			<p class="col-12 text-center">Reference: <b><i> Rahman M.M.(2022) An overview of Horizontal Datums and Map Projections for GIS Application in Bangladesh</i></b></p>
		</div>
		<div class="row justify-content-center">
			<div class="col-auto g-3">
				<select class="form-select" aria-label="Default select example" id="convertFrom" onchange="getFromValue()">
				  <option selected>Convert From</option>
				</select>
			</div>
			<div class="col-auto g-3">
				<select class="form-select" aria-label="Default select example" id="convertTo" onchange="getToValue()">
				  <option selected>Convert To</option>
				</select>
			</div>
			<div class="col-auto g-3">
				<input class="form-control" type="file" id="fileUpload" accept=".csv" onchange="Upload()" disabled />
			</div>
			<div class="col-auto g-3">
				<button type="button" class="btn btn-primary" id="btnDownload" onclick="downloadCSVFile()" disabled>download</button>
			</div>
		</div>
	</div>
	
	<hr />
	
	<div class="p-2">
		<div id="dvCSV"></div>
	</div>

</body>
    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
	
	<!--proj4js for Coordinate Converstion-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/1.4.0/proj4.js" integrity="sha512-9FBAecJh0Z6E49D3yaooSbeH7Br8Pe+jVCsZVfo4alGWOuv5RqKwE5YsCv88Ma0iG8aUGWvfb92zDVJ9ywJPHA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	
	<!--papaparse for reading/writing CSV easily-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js" integrity="sha512-EbdJQSugx0nVWrtyK3JdQQ/03mS3Q1UiAhRtErbwl1YL/+e2hZdlIcSURxxh7WXHTzn83sjlh2rysACoJGfb6g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	
	<script type="text/javascript">
		//Geographic Coordinate Systems
		var wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"; //epsg4326
		var gulshan303 = "+proj=longlat +ellps=evrst30 +towgs84=283.729,735.942,261.143,0,0,0,0 +no_defs"; //epsg4682
		
		//Projected Coordinate Systems
		//BTM using Local Datum Everest 1930 (1937 Adjustment) EPSG 9678
		var proj_name = 'BTM'
		var a = 6377276.345
		var b = 6356075.413
		var f = (a-b)/a
		var f_inverse = 1/f
		var dx = 283.729
		var dy = 735.942
		var dz = 261.143
		var rx = 0
		var ry = 0
		var rz = 0
		var s = 0
		var proj = 'tmerc'  // Transverse Mercator
		var fe = 500000     // False Easting
		var fn = -2000000   // False Northing
		var k = 0.9996      // Scale Factor
		var lat_origin = 0  // Central Parallel
		var lon_origin = 90 // Central Meridian
		var unit = 'm'      // unit in meter
		var btm = `+proj=${proj} +lat_0=${lat_origin} +lon_0=${lon_origin} +k=${k} +x_0=${fe} +y_0=${fn} +a=${a} +b=${b} +towgs84=${dx},${dy},${dz},${rx},${ry},${rz},${s} +units=${unit} +no_defs`
		
		//using global WGS84 datum
		var utm45N = "+proj=utm +zone=45 +datum=WGS84 +units=m +no_defs"; //epsg32645
		var utm46N = "+proj=utm +zone=46 +datum=WGS84 +units=m +no_defs"; //epsg32646
		var butm2000 = "+proj=tmerc +lat_0=0 +lon_0=90 +k=0.9996 +x_0=500000 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs" //epsg9680
		
		
		var coordinate_systems = {
			"WGS84":wgs84,
			"GULSHAN303":gulshan303,
			"BTM": btm, 
			"BUTM2010":butm2000, 
			"UTM45N":utm45N, 
			"UTM46N":utm46N
		}
		
		//General Conversion Function lon,easting = x and lat,northing = y
		function convert_coordinate(from,to,x,y){
			var converted_x = proj4(coordinate_systems[from], coordinate_systems[to], [x,y])[0]
			var converted_y = proj4(coordinate_systems[from], coordinate_systems[to], [x,y])[1]
			return [converted_x, converted_y]
		}
		
		//Testing
		//Easting = 557825m and Northing = 666932m gives Latitude = 24.116377062446542degree and Longitude = 90.5662427832349 respectively
		//var lat = convert_coordinate("BTM", "WGS84", 557825, 666932)[1]
		//var lon = convert_coordinate("BTM", "WGS84", 557825, 666932)[0]
		//console.log(lat, lon);
		
	</script>
	
	
	
	<script type="text/javascript">
		var gcsItems = ["WGS84", "GULSHAN303"]
		var pcsItems = ["BTM", "BUTM2010", "UTM45N", "UTM46N"]
		var conversionItems = gcsItems.concat(pcsItems);
		var convertFromElem = document.getElementById("convertFrom");
		var convertToElem = document.getElementById("convertTo");
		var convertFromVal
		var convertToVal
		
		//Add Element in convertFrom List
		for (var i = 0; i < conversionItems.length; i++){
		  var item = conversionItems[i];
		  var element = document.createElement("option");
		  element.innerText = item;
		  convertFromElem.append(element);
		};
		
		function getFromValue(){
			
			convertFromVal = convertFromElem.options[convertFromElem.selectedIndex].text;
			
			var newConversionItems = [...conversionItems]	//shallow copy the list to keep the original list intact
			//Remove the ConvertFrom item from the list
			const index = newConversionItems.indexOf(convertFromVal);
			if (index > -1) {
			  newConversionItems.splice(index, 1); // 2nd parameter means remove one item only
			}
			
			//Add Element in convertTo List (Remove if any available from previous selection
			for (i in convertToElem.options) {
				convertToElem.options.remove(0); 
			};
			for (var i = 0; i < newConversionItems.length; i++){
			  var item = newConversionItems[i];
			  var element = document.createElement("option");
			  element.innerText = item;
			  convertToElem.append(element);
			};
			
			//convertToVal default is the first item of the new list
			convertToVal = newConversionItems[0];
			
			console.log(convertFromVal);
			console.log(convertToVal);
			
			if ((typeof convertFromVal !== "undefined") && (typeof convertToVal !== "undefined")){
				document.getElementById('fileUpload').removeAttribute('disabled')
			}
			
		};
		
		function getToValue(){
			convertToVal = convertToElem.options[convertToElem.selectedIndex].text;
			console.log(convertToVal);
			if ((typeof convertFromVal !== "undefined") && (typeof convertToVal !== "undefined")){
				document.getElementById('fileUpload').removeAttribute('disabled')
			}
		};
		
	</script>
	
	<script type="text/javascript">
		var csv_columns = []
		var csv_data
		var converted_csv_data
		
		var export_data = []
		var eastings = []
		var northings = []
		
		function Upload() {
			var file = fileUpload.files[0]
			// Parse local CSV file
			Papa.parse(file, {
				header: true,
				skipEmptyLines: true,
				complete: function(results) {
					//console.table(results.data);
					
					csv_data = results.data
					csv_columns = Object.keys(csv_data[0])
					
					//IF converted from GCS
					if (gcsItems.includes(convertFromVal)){
						//Check for Lat Lon Column in CSV
						if (csv_columns.includes("Latitude") && csv_columns.includes("Longitude")){
							console.log("Latitude Longitude values found")
							//If converted to PCS (e.g., BTM, BUTM2010, UTM45N, UTM46N)
							if (pcsItems.includes(convertToVal)){
								for (i=0; i<csv_data.length; i++){
									csv_data[i]["Easting_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Longitude"], csv_data[i]["Latitude"])[0]
									csv_data[i]["Northing_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Longitude"], csv_data[i]["Latitude"])[1]
								}
							//If converted to GCS (e.g., WGS84, GULSHAN303)	
							} else {
								for (i=0; i<csv_data.length; i++){
									csv_data[i]["Latitude_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Longitude"], csv_data[i]["Latitude"])[1]
									csv_data[i]["Longitude_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Longitude"], csv_data[i]["Latitude"])[0]
								}
							}
							converted_csv_data = Papa.unparse(csv_data);
							document.getElementById('btnDownload').removeAttribute('disabled')
						//No Lat Lon Column present	
						} else {
							alert("CSV file does not contain Latitude Longitude values");
							window.location.reload();
						}
					//IF converted from PCS	
					} else {
						//Check for Easting Northing Column in CSV
						if (csv_columns.includes("Easting") && csv_columns.includes("Northing")){
							console.log("Easting Northing values found")
							//Conversion code here
							//If converted to PCS (e.g., BTM, BUTM2010, UTM45N, UTM46N)
							if (pcsItems.includes(convertToVal)){
								for (i=0; i<csv_data.length; i++){
									csv_data[i]["Easting_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Easting"], csv_data[i]["Northing"])[0]
									csv_data[i]["Northing_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Easting"], csv_data[i]["Northing"])[1]
								}
							//If converted to GCS (e.g., WGS84, GULSHAN303)	
							} else {
								for (i=0; i<csv_data.length; i++){
									csv_data[i]["Latitude_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Easting"], csv_data[i]["Northing"])[1]
									csv_data[i]["Longitude_Converted"] = convert_coordinate(convertFromVal, convertToVal, csv_data[i]["Easting"], csv_data[i]["Northing"])[0]
								}
							}
							converted_csv_data = Papa.unparse(csv_data);
							document.getElementById('btnDownload').removeAttribute('disabled')
						} else {
							alert("CSV file does not contain Easting Northing values");
							window.location.reload();
						}
					}
					
					//Create HTML table for visualiztion of CSV Data
					var table_html = '<table class="table table-bordered table-hover p-2">';
					table_html += '<tr>';
					//Preparing the header of the table
					for( var j in csv_data[0] ) {
						table_html += '<th>' + j + '</th>';
					}
					table_html += '</tr>';
					//Preparing the body of the table
					for( var i = 0; i < csv_data.length; i++) {
						table_html += '<tr>';
						for( var j in csv_data[i] ) {
							table_html += '<td>' + csv_data[i][j] + '</td>';
						}
						table_html += '</tr>';
					}
					table_html += '</table>';
					document.getElementById('dvCSV').innerHTML = table_html;

				}
			});
		};
		
		
        function downloadCSVFile() {
            // Create CSV file object and feed
            // our final csv_data into it
            CSVFile = new Blob([converted_csv_data], {
                type: "text/csv"
            });
 
            // Create to temporary link to initiate
            // download process
            var temp_link = document.createElement('a');
 
            // Download csv file
            temp_link.download = convertFromVal+"_to_"+convertToVal+".csv";
            var url = window.URL.createObjectURL(CSVFile);
            temp_link.href = url;
 
            // This link should not be displayed
            temp_link.style.display = "none";
            document.body.appendChild(temp_link);
 
            // Automatically click the link to
            // trigger download
            temp_link.click();
            document.body.removeChild(temp_link);
			window.location.reload();
        }
	</script>
</html>